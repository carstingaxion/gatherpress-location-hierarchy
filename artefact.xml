<?xml version="1.0" encoding="UTF-8"?>
<artefact xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="artefact.xsd" name="GatherPress Venue Hierarchy" slug="gatherpress-venue-hierarchy" type="code-package" schemaVersion="2">
  <file path="readme.txt">
    <description>This file contains the readme information for the block. It is used to provide information about the block, its usage, and any other relevant details.</description>
    <content><![CDATA[=== GatherPress Venue Hierarchy ===

Contributors:      WordPress Telex
Tags:              block, gatherpress, venue, hierarchy, geocoding
Tested up to:      6.8
Stable tag:        0.1.0
License:           GPLv2 or later
License URI:       https://www.gnu.org/licenses/gpl-2.0.html
Adds hierarchical location taxonomy to GatherPress with automatic geocoding

== Description ==

This plugin enhances GatherPress by adding a new hierarchical "gatherpress-location" taxonomy. It automatically geocodes venue addresses using the Nominatim API and generates a structured hierarchy of geographic terms: continent as top-level parent, country as child of continent, state/region as child of country, and county/city as child of state.

Key features:

* Creates new hierarchical "gatherpress-location" taxonomy
* Works alongside existing GatherPress venue system
* Automatic geocoding via Nominatim API with one-hour caching
* Generates geographic hierarchy: Continent > Country > State > City
* Checks for existing terms before creation
* Admin settings for default geographic terms
* Support for German-speaking regions (DE, AT, CH, LU)
* Filter events by location at any level
* Custom block for displaying full location hierarchy as inline text
* Singleton pattern implementation
* Comprehensive error logging and validation

The plugin includes a custom Gutenberg block that displays the complete location hierarchy as a single inline text string, showing all parent and child location terms in one continuous paragraph line.

== Installation ==

1. Ensure GatherPress plugin is installed and activated
2. Upload the plugin files to the `/wp-content/plugins/gatherpress-venue-hierarchy` directory, or install the plugin through the WordPress plugins screen directly
3. Activate the plugin through the 'Plugins' screen in WordPress
4. Navigate to Settings > GatherPress Location to configure default geographic terms
5. Add the "Location Hierarchy Display" block to any post or page to show location information

== Frequently Asked Questions ==

= Does this require GatherPress? =

Yes, this is an add-on for GatherPress and requires the GatherPress plugin to be installed and activated.

= How does the geocoding work? =

The plugin uses the Nominatim API to geocode venue addresses. Results are cached as transients for one hour to minimize API calls.

= Can I set default locations? =

Yes, you can configure default continent, country, state, and city terms in the plugin settings under Settings > GatherPress Location.

= What regions are supported? =

The plugin has enhanced support for German-speaking regions (Germany, Austria, Switzerland, Luxembourg) but works with any geographic location worldwide.

== Screenshots ==

1. Admin settings page for configuring default geographic terms
2. Location hierarchy block displaying inline location path
3. Event filtered by continent, country, state, or city

== Changelog ==

= 0.1.0 =
* Initial release
* New hierarchical gatherpress-location taxonomy
* Nominatim API geocoding integration
* Geographic term hierarchy generation with continent as top level
* Admin settings panel
* Custom location hierarchy display block
* Caching and error handling

== Usage ==

After activation, the plugin creates a new "gatherpress-location" taxonomy. When creating or editing venues in GatherPress:

1. Enter the venue address
2. The plugin automatically geocodes and creates hierarchical location terms
3. Use the admin settings to set default geographic locations
4. Add the "Location Hierarchy Display" block to show location information
5. Filter events by continent, country, state, or city in both editor and frontend

The location hierarchy block displays the complete path as inline text, for example: "Europe > Germany > Bavaria > Munich > Conference Center"]]></content>
  </file>
  <file path="gatherpress-venue-hierarchy.php">
    <description>This file contains the block registration code in the form of a single block plugin. Any other plugin related functionality should be added to this file. All block rendering functionality should go to the `render.php` file.</description>
    <content><![CDATA[<?php
/**
 * Plugin Name:       GatherPress Venue Hierarchy
 * Plugin URI:        https://github.com/automattic/gatherpress-venue-hierarchy
 * Description:       Adds hierarchical location taxonomy to GatherPress with automatic geocoding
 * Version:           0.1.0
 * Requires at least: 6.0
 * Requires PHP:      7.4
 * Author:            WordPress Telex
 * License:           GPLv2 or later
 * License URI:       https://www.gnu.org/licenses/gpl-2.0.html
 * Text Domain:       gatherpress-venue-hierarchy
 *
 * @package GatherPressVenueHierarchy
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}

/**
 * Main plugin class using Singleton pattern.
 *
 * Handles registration of the hierarchical location taxonomy,
 * admin settings, and coordinates geocoding and hierarchy building
 * for GatherPress venues.
 *
 * @since 0.1.0
 */
class GatherPress_Venue_Hierarchy {
	
	/**
	 * Single instance of the class.
	 *
	 * @since 0.1.0
	 * @var GatherPress_Venue_Hierarchy|null
	 */
	private static $instance = null;
	
	/**
	 * Taxonomy name for hierarchical locations.
	 *
	 * @since 0.1.0
	 * @var string
	 */
	private $taxonomy = 'gatherpress-location';
	
	/**
	 * Get singleton instance.
	 *
	 * Ensures only one instance of the class exists.
	 *
	 * @since 0.1.0
	 * @return GatherPress_Venue_Hierarchy The singleton instance.
	 */
	public static function get_instance(): GatherPress_Venue_Hierarchy {
		if ( null === self::$instance ) {
			self::$instance = new self();
		}
		return self::$instance;
	}
	
	/**
	 * Constructor.
	 *
	 * Private constructor to enforce singleton pattern.
	 * Registers all WordPress hooks and filters.
	 *
	 * @since 0.1.0
	 */
	private function __construct() {
		add_action( 'init', array( $this, 'init' ) );
		add_action( 'admin_menu', array( $this, 'add_admin_menu' ) );
		add_action( 'admin_init', array( $this, 'register_settings' ) );
		add_action( 'save_post_gatherpress_event', array( $this, 'maybe_geocode_event_venue' ), 20, 2 );
		add_filter( 'get_terms_args', array( $this, 'order_location_terms_hierarchically' ), 10, 2 );
		add_filter( 'terms_clauses', array( $this, 'modify_location_terms_query' ), 10, 3 );
	}
	
	/**
	 * Initialize plugin.
	 *
	 * Registers the location taxonomy and block type.
	 * Fires on the 'init' action.
	 *
	 * @since 0.1.0
	 * @return void
	 */
	public function init(): void {
		$this->register_location_taxonomy();
		$this->register_block();
	}
	
	/**
	 * Register the hierarchical location taxonomy.
	 *
	 * Creates a hierarchical taxonomy for organizing venues
	 * by continent, country, state/region, and city.
	 *
	 * @since 0.1.0
	 * @return void
	 */
	public function register_location_taxonomy(): void {
		$labels = array(
			'name'                       => __( 'Locations', 'gatherpress-venue-hierarchy' ),
			'singular_name'              => __( 'Location', 'gatherpress-venue-hierarchy' ),
			'search_items'               => __( 'Search Locations', 'gatherpress-venue-hierarchy' ),
			'all_items'                  => __( 'All Locations', 'gatherpress-venue-hierarchy' ),
			'parent_item'                => __( 'Parent Location', 'gatherpress-venue-hierarchy' ),
			'parent_item_colon'          => __( 'Parent Location:', 'gatherpress-venue-hierarchy' ),
			'edit_item'                  => __( 'Edit Location', 'gatherpress-venue-hierarchy' ),
			'update_item'                => __( 'Update Location', 'gatherpress-venue-hierarchy' ),
			'add_new_item'               => __( 'Add New Location', 'gatherpress-venue-hierarchy' ),
			'new_item_name'              => __( 'New Location Name', 'gatherpress-venue-hierarchy' ),
			'menu_name'                  => __( 'Locations', 'gatherpress-venue-hierarchy' ),
		);
		
		$args = array(
			'labels'                     => $labels,
			'hierarchical'               => true,
			'public'                     => true,
			'show_ui'                    => true,
			'show_admin_column'          => true,
			'show_in_nav_menus'          => true,
			'show_tagcloud'              => true,
			'show_in_rest'               => true,
			'rewrite'                    => array( 'slug' => 'location' ),
		);
		
		register_taxonomy( $this->taxonomy, array( 'gatherpress_event' ), $args );
	}
	
	/**
	 * Order location terms hierarchically.
	 *
	 * Modifies term query arguments to ensure location terms
	 * are always ordered from parent to child (continent > country > state > city).
	 *
	 * @since 0.1.0
	 * @param array<string, mixed> $args     Query arguments.
	 * @param array<string>        $taxonomies Array of taxonomy names.
	 * @return array<string, mixed> Modified query arguments.
	 */
	public function order_location_terms_hierarchically( array $args, array $taxonomies ): array {
		if ( ! in_array( $this->taxonomy, $taxonomies, true ) ) {
			return $args;
		}
		
		if ( isset( $args['orderby'] ) && 'none' !== $args['orderby'] ) {
			return $args;
		}
		
		$args['orderby'] = 'parent';
		$args['order'] = 'ASC';
		
		return $args;
	}
	
	/**
	 * Modify location terms query to order by hierarchy depth.
	 *
	 * Modifies the SQL query to ensure terms are ordered from
	 * top-level parents down to children, maintaining the
	 * continent > country > state > city hierarchy.
	 *
	 * @since 0.1.0
	 * @param array<string>        $clauses    Query clauses.
	 * @param array<string>        $taxonomies Array of taxonomy names.
	 * @param array<string, mixed> $args       Query arguments.
	 * @return array<string> Modified query clauses.
	 */
	public function modify_location_terms_query( array $clauses, array $taxonomies, array $args ): array {
		if ( ! in_array( $this->taxonomy, $taxonomies, true ) ) {
			return $clauses;
		}
		
		if ( ! isset( $args['orderby'] ) || 'parent' !== $args['orderby'] ) {
			return $clauses;
		}
		
		global $wpdb;
		
		$clauses['orderby'] = "ORDER BY t.parent ASC, t.term_id ASC";
		
		return $clauses;
	}
	
	/**
	 * Register the location hierarchy display block.
	 *
	 * @since 0.1.0
	 * @return void
	 */
	public function register_block(): void {
		register_block_type( __DIR__ . '/build/' );
	}
	
	/**
	 * Add admin menu for plugin settings.
	 *
	 * Creates a submenu page under Settings for configuring
	 * default geographic locations.
	 *
	 * @since 0.1.0
	 * @return void
	 */
	public function add_admin_menu(): void {
		add_options_page(
			__( 'GatherPress Location', 'gatherpress-venue-hierarchy' ),
			__( 'GatherPress Location', 'gatherpress-venue-hierarchy' ),
			'manage_options',
			'gatherpress-venue-hierarchy',
			array( $this, 'render_admin_page' )
		);
	}
	
	/**
	 * Register plugin settings.
	 *
	 * Registers settings for default continent, country, state, and city values.
	 *
	 * @since 0.1.0
	 * @return void
	 */
	public function register_settings(): void {
		register_setting(
			'gatherpress_venue_hierarchy',
			'gatherpress_venue_hierarchy_defaults',
			array(
				'type' => 'array',
				'sanitize_callback' => array( $this, 'sanitize_settings' ),
				'default' => array(
					'continent' => '',
					'country' => '',
					'state' => '',
					'city' => '',
				),
			)
		);
	}
	
	/**
	 * Sanitize settings input.
	 *
	 * Ensures all settings values are properly sanitized before saving.
	 *
	 * @since 0.1.0
	 * @param mixed $input Raw settings input from form submission.
	 * @return array<string, string> Sanitized settings array.
	 */
	public function sanitize_settings( $input ): array {
		if ( ! is_array( $input ) ) {
			$input = array();
		}
		
		return array(
			'continent' => sanitize_text_field( $input['continent'] ?? '' ),
			'country' => sanitize_text_field( $input['country'] ?? '' ),
			'state' => sanitize_text_field( $input['state'] ?? '' ),
			'city' => sanitize_text_field( $input['city'] ?? '' ),
		);
	}
	
	/**
	 * Render the admin settings page.
	 *
	 * Displays the settings form for configuring default locations.
	 * Includes fields for continent, country, state, and city.
	 *
	 * @since 0.1.0
	 * @return void
	 */
	public function render_admin_page(): void {
		if ( ! current_user_can( 'manage_options' ) ) {
			return;
		}
		
		$defaults = get_option( 'gatherpress_venue_hierarchy_defaults', array(
			'continent' => '',
			'country' => '',
			'state' => '',
			'city' => '',
		) );
		
		if ( ! is_array( $defaults ) ) {
			$defaults = array(
				'continent' => '',
				'country' => '',
				'state' => '',
				'city' => '',
			);
		}
		?>
		<div class="wrap">
			<h1><?php echo esc_html( get_admin_page_title() ); ?></h1>
			<form method="post" action="options.php">
				<?php settings_fields( 'gatherpress_venue_hierarchy' ); ?>
				<table class="form-table">
					<tr>
						<th scope="row">
							<label for="default_continent"><?php esc_html_e( 'Default Continent', 'gatherpress-venue-hierarchy' ); ?></label>
						</th>
						<td>
							<input type="text" id="default_continent" name="gatherpress_venue_hierarchy_defaults[continent]" 
								value="<?php echo esc_attr( $defaults['continent'] ?? '' ); ?>" class="regular-text">
							<p class="description"><?php esc_html_e( 'Default continent for new venues', 'gatherpress-venue-hierarchy' ); ?></p>
						</td>
					</tr>
					<tr>
						<th scope="row">
							<label for="default_country"><?php esc_html_e( 'Default Country', 'gatherpress-venue-hierarchy' ); ?></label>
						</th>
						<td>
							<input type="text" id="default_country" name="gatherpress_venue_hierarchy_defaults[country]" 
								value="<?php echo esc_attr( $defaults['country'] ?? '' ); ?>" class="regular-text">
							<p class="description"><?php esc_html_e( 'Default country for new venues', 'gatherpress-venue-hierarchy' ); ?></p>
						</td>
					</tr>
					<tr>
						<th scope="row">
							<label for="default_state"><?php esc_html_e( 'Default State/Region', 'gatherpress-venue-hierarchy' ); ?></label>
						</th>
						<td>
							<input type="text" id="default_state" name="gatherpress_venue_hierarchy_defaults[state]" 
								value="<?php echo esc_attr( $defaults['state'] ?? '' ); ?>" class="regular-text">
							<p class="description"><?php esc_html_e( 'Default state or region for new venues', 'gatherpress-venue-hierarchy' ); ?></p>
						</td>
					</tr>
					<tr>
						<th scope="row">
							<label for="default_city"><?php esc_html_e( 'Default City', 'gatherpress-venue-hierarchy' ); ?></label>
						</th>
						<td>
							<input type="text" id="default_city" name="gatherpress_venue_hierarchy_defaults[city]" 
								value="<?php echo esc_attr( $defaults['city'] ?? '' ); ?>" class="regular-text">
							<p class="description"><?php esc_html_e( 'Default city for new venues', 'gatherpress-venue-hierarchy' ); ?></p>
						</td>
					</tr>
				</table>
				<?php submit_button(); ?>
			</form>
		</div>
		<?php
	}
	
	/**
	 * Maybe geocode event venue on save.
	 *
	 * Triggers geocoding and hierarchy generation when a GatherPress
	 * event is saved. Skips if autosaving or if no venue address exists.
	 *
	 * @since 0.1.0
	 * @param int     $post_id Post ID of the event.
	 * @param \WP_Post $post    Post object.
	 * @return void
	 */
	public function maybe_geocode_event_venue( int $post_id, \WP_Post $post ): void {
		if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) {
			return;
		}
		
		if ( 'gatherpress_event' !== $post->post_type ) {
			return;
		}
		
		if ( ! class_exists( 'GatherPress\Core\Event' ) ) {
			error_log( 'GatherPress Venue Hierarchy: GatherPress Event class not found' );
			return;
		}
		
		$event = new \GatherPress\Core\Event( $post_id );
		$venue_info = $event->get_venue_information();
		
		if ( ! is_array( $venue_info ) || empty( $venue_info['full_address'] ) ) {
			return;
		}
		
		$this->geocode_and_create_hierarchy( $post_id, $venue_info['full_address'] );
	}
	
	/**
	 * Geocode address and create location hierarchy.
	 *
	 * Coordinates the geocoding process via Nominatim API and
	 * generates the hierarchical location terms.
	 *
	 * @since 0.1.0
	 * @param int    $post_id Post ID to associate terms with.
	 * @param string $address Address to geocode.
	 * @return void
	 */
	private function geocode_and_create_hierarchy( int $post_id, string $address ): void {
		$geocoder = GatherPress_Venue_Geocoder::get_instance();
		$location = $geocoder->geocode( $address );
		
		if ( ! $location ) {
			error_log( 'GatherPress Venue Hierarchy: Failed to geocode address for event ' . $post_id );
			return;
		}
		
		$hierarchy_builder = GatherPress_Venue_Hierarchy_Builder::get_instance();
		$hierarchy_builder->create_hierarchy_terms( $post_id, $location, $this->taxonomy );
	}
}

/**
 * Geocoder class using Singleton pattern.
 *
 * Handles geocoding of addresses via the Nominatim OpenStreetMap API.
 * Includes caching to minimize API calls and parsing of location data
 * with special handling for German-speaking regions. Extracts continent
 * information as the top-level location hierarchy.
 *
 * @since 0.1.0
 */
class GatherPress_Venue_Geocoder {
	
	/**
	 * Single instance.
	 *
	 * @since 0.1.0
	 * @var GatherPress_Venue_Geocoder|null
	 */
	private static $instance = null;
	
	/**
	 * Nominatim API endpoint.
	 *
	 * @since 0.1.0
	 * @var string
	 */
	private $api_endpoint = 'https://nominatim.openstreetmap.org/search';
	
	/**
	 * Cache duration in seconds (1 hour).
	 *
	 * @since 0.1.0
	 * @var int
	 */
	private $cache_duration = 3600;
	
	/**
	 * Country to continent mapping.
	 *
	 * @since 0.1.0
	 * @var array<string, string>
	 */
	private $country_continents = array(
		// Europe
		'de' => 'Europe', 'at' => 'Europe', 'ch' => 'Europe', 'fr' => 'Europe',
		'it' => 'Europe', 'es' => 'Europe', 'pt' => 'Europe', 'uk' => 'Europe',
		'gb' => 'Europe', 'ie' => 'Europe', 'nl' => 'Europe', 'be' => 'Europe',
		'lu' => 'Europe', 'se' => 'Europe', 'no' => 'Europe', 'dk' => 'Europe',
		'fi' => 'Europe', 'pl' => 'Europe', 'cz' => 'Europe', 'sk' => 'Europe',
		'hu' => 'Europe', 'ro' => 'Europe', 'bg' => 'Europe', 'gr' => 'Europe',
		'hr' => 'Europe', 'si' => 'Europe', 'rs' => 'Europe', 'ba' => 'Europe',
		'me' => 'Europe', 'mk' => 'Europe', 'al' => 'Europe', 'tr' => 'Europe',
		'ru' => 'Europe', 'ua' => 'Europe', 'by' => 'Europe', 'md' => 'Europe',
		'ee' => 'Europe', 'lv' => 'Europe', 'lt' => 'Europe', 'is' => 'Europe',
		// North America
		'us' => 'North America', 'ca' => 'North America', 'mx' => 'North America',
		'gt' => 'North America', 'bz' => 'North America', 'sv' => 'North America',
		'hn' => 'North America', 'ni' => 'North America', 'cr' => 'North America',
		'pa' => 'North America', 'cu' => 'North America', 'jm' => 'North America',
		'ht' => 'North America', 'do' => 'North America', 'pr' => 'North America',
		// South America
		'br' => 'South America', 'ar' => 'South America', 'cl' => 'South America',
		'co' => 'South America', 'pe' => 'South America', 've' => 'South America',
		'ec' => 'South America', 'bo' => 'South America', 'py' => 'South America',
		'uy' => 'South America', 'gy' => 'South America', 'sr' => 'South America',
		// Asia
		'cn' => 'Asia', 'jp' => 'Asia', 'in' => 'Asia', 'id' => 'Asia',
		'pk' => 'Asia', 'bd' => 'Asia', 'ph' => 'Asia', 'vn' => 'Asia',
		'th' => 'Asia', 'mm' => 'Asia', 'kr' => 'Asia', 'af' => 'Asia',
		'kp' => 'Asia', 'tw' => 'Asia', 'my' => 'Asia', 'np' => 'Asia',
		'lk' => 'Asia', 'kh' => 'Asia', 'la' => 'Asia', 'sg' => 'Asia',
		'mn' => 'Asia', 'bt' => 'Asia', 'mv' => 'Asia', 'bn' => 'Asia',
		'il' => 'Asia', 'jo' => 'Asia', 'lb' => 'Asia', 'sy' => 'Asia',
		'iq' => 'Asia', 'ir' => 'Asia', 'sa' => 'Asia', 'ye' => 'Asia',
		'om' => 'Asia', 'ae' => 'Asia', 'qa' => 'Asia', 'kw' => 'Asia',
		'bh' => 'Asia', 'am' => 'Asia', 'az' => 'Asia', 'ge' => 'Asia',
		'kz' => 'Asia', 'uz' => 'Asia', 'tm' => 'Asia', 'kg' => 'Asia',
		'tj' => 'Asia',
		// Africa
		'ng' => 'Africa', 'et' => 'Africa', 'eg' => 'Africa', 'cd' => 'Africa',
		'za' => 'Africa', 'tz' => 'Africa', 'ke' => 'Africa', 'ug' => 'Africa',
		'dz' => 'Africa', 'sd' => 'Africa', 'ma' => 'Africa', 'ao' => 'Africa',
		'gh' => 'Africa', 'mz' => 'Africa', 'mg' => 'Africa', 'cm' => 'Africa',
		'ci' => 'Africa', 'ne' => 'Africa', 'bf' => 'Africa', 'ml' => 'Africa',
		'mw' => 'Africa', 'zm' => 'Africa', 'so' => 'Africa', 'sn' => 'Africa',
		'td' => 'Africa', 'zw' => 'Africa', 'gn' => 'Africa', 'rw' => 'Africa',
		'bj' => 'Africa', 'tn' => 'Africa', 'bi' => 'Africa', 'ss' => 'Africa',
		'tg' => 'Africa', 'sl' => 'Africa', 'ly' => 'Africa', 'lr' => 'Africa',
		'mr' => 'Africa', 'cf' => 'Africa', 'er' => 'Africa', 'gm' => 'Africa',
		'bw' => 'Africa', 'ga' => 'Africa', 'gw' => 'Africa', 'mu' => 'Africa',
		'sz' => 'Africa', 'dj' => 'Africa', 'gq' => 'Africa', 'km' => 'Africa',
		// Oceania
		'au' => 'Oceania', 'pg' => 'Oceania', 'nz' => 'Oceania', 'fj' => 'Oceania',
		'sb' => 'Oceania', 'nc' => 'Oceania', 'pf' => 'Oceania', 'vu' => 'Oceania',
		'ws' => 'Oceania', 'ki' => 'Oceania', 'fm' => 'Oceania', 'to' => 'Oceania',
		'pw' => 'Oceania', 'mh' => 'Oceania', 'nr' => 'Oceania', 'tv' => 'Oceania',
		// Antarctica
		'aq' => 'Antarctica',
	);
	
	/**
	 * Get singleton instance.
	 *
	 * @since 0.1.0
	 * @return GatherPress_Venue_Geocoder The singleton instance.
	 */
	public static function get_instance(): GatherPress_Venue_Geocoder {
		if ( null === self::$instance ) {
			self::$instance = new self();
		}
		return self::$instance;
	}
	
	/**
	 * Constructor.
	 *
	 * Private constructor to enforce singleton pattern.
	 *
	 * @since 0.1.0
	 */
	private function __construct() {}
	
	/**
	 * Geocode an address.
	 *
	 * Queries the Nominatim API to get geographic coordinates and
	 * location details. Results are cached for one hour.
	 *
	 * @since 0.1.0
	 * @param string $address Address to geocode.
	 * @return array<string, string>|false Location data array with keys:
	 *                                      'continent', 'country', 'country_code', 'state', 'city'
	 *                                      or false on failure.
	 */
	public function geocode( string $address ) {
		$address = sanitize_text_field( $address );
		$cache_key = 'gpvh_geocode_' . md5( $address );
		
		$cached = get_transient( $cache_key );
		if ( false !== $cached ) {
			return $cached;
		}
		
		$response = wp_remote_get(
			add_query_arg(
				array(
					'q' => $address,
					'format' => 'json',
					'addressdetails' => '1',
					'limit' => '1',
				),
				$this->api_endpoint
			),
			array(
				'timeout' => 10,
				'headers' => array(
					'User-Agent' => 'GatherPress Venue Hierarchy WordPress Plugin',
				),
			)
		);
		
		if ( is_wp_error( $response ) ) {
			error_log( 'GatherPress Venue Hierarchy: Geocoding API error - ' . $response->get_error_message() );
			return false;
		}
		
		$body = wp_remote_retrieve_body( $response );
		$data = json_decode( $body, true );
		
		if ( empty( $data ) || ! is_array( $data ) ) {
			error_log( 'GatherPress Venue Hierarchy: Invalid API response for address: ' . $address );
			return false;
		}
		
		$location = $this->parse_location_data( $data[0] );
		
		if ( $location ) {
			set_transient( $cache_key, $location, $this->cache_duration );
		}
		
		return $location;
	}
	
	/**
	 * Parse location data from API response.
	 *
	 * Extracts continent, country, state, and city information from the Nominatim
	 * API response with special handling for German-speaking regions.
	 *
	 * @since 0.1.0
	 * @param array<string, mixed> $data API response data.
	 * @return array<string, string>|false Parsed location data or false on failure.
	 */
	private function parse_location_data( array $data ) {
		if ( empty( $data['address'] ) || ! is_array( $data['address'] ) ) {
			return false;
		}
		
		$address = $data['address'];
		$country_code = strtolower( $address['country_code'] ?? '' );
		
		// Get continent from country code
		$continent = $this->country_continents[ $country_code ] ?? 'Unknown';
		
		$location = array(
			'continent' => $continent,
			'country' => $this->sanitize_term_name( $address['country'] ?? '' ),
			'country_code' => $country_code,
			'state' => '',
			'city' => '',
		);
		
		$german_regions = array( 'de', 'at', 'ch', 'lu' );
		$is_german_region = in_array( $country_code, $german_regions, true );
		
		if ( $is_german_region ) {
			$location['state'] = $this->sanitize_term_name( $address['state'] ?? '' );
		} else {
			$location['state'] = $this->sanitize_term_name( 
				$address['state'] ?? $address['region'] ?? $address['province'] ?? '' 
			);
		}
		
		$location['city'] = $this->sanitize_term_name(
			$address['city'] ?? $address['town'] ?? $address['village'] ?? $address['county'] ?? ''
		);
		
		return array_filter( $location );
	}
	
	/**
	 * Sanitize term name.
	 *
	 * Removes unwanted characters and trims whitespace.
	 *
	 * @since 0.1.0
	 * @param string $name Term name to sanitize.
	 * @return string Sanitized term name.
	 */
	private function sanitize_term_name( string $name ): string {
		return trim( sanitize_text_field( $name ) );
	}
}

/**
 * Hierarchy builder class using Singleton pattern.
 *
 * Creates and manages hierarchical taxonomy terms for locations,
 * establishing parent-child relationships between continent, country, state, and city.
 *
 * @since 0.1.0
 */
class GatherPress_Venue_Hierarchy_Builder {
	
	/**
	 * Single instance.
	 *
	 * @since 0.1.0
	 * @var GatherPress_Venue_Hierarchy_Builder|null
	 */
	private static $instance = null;
	
	/**
	 * Get singleton instance.
	 *
	 * @since 0.1.0
	 * @return GatherPress_Venue_Hierarchy_Builder The singleton instance.
	 */
	public static function get_instance(): GatherPress_Venue_Hierarchy_Builder {
		if ( null === self::$instance ) {
			self::$instance = new self();
		}
		return self::$instance;
	}
	
	/**
	 * Constructor.
	 *
	 * Private constructor to enforce singleton pattern.
	 *
	 * @since 0.1.0
	 */
	private function __construct() {}
	
	/**
	 * Create hierarchy terms.
	 *
	 * Generates hierarchical taxonomy terms for continent, country, state, and city,
	 * establishing proper parent-child relationships and associating them
	 * with the specified post.
	 *
	 * @since 0.1.0
	 * @param int                  $post_id  Post ID to associate terms with.
	 * @param array<string, string> $location Location data array with keys:
	 *                                       'continent', 'country', 'state', 'city'.
	 * @param string               $taxonomy Taxonomy name.
	 * @return void
	 */
	public function create_hierarchy_terms( int $post_id, array $location, string $taxonomy ): void {
		$continent_term_id = 0;
		$country_term_id = 0;
		$state_term_id = 0;
		$city_term_id = 0;
		
		if ( ! empty( $location['continent'] ) ) {
			$continent_term_id = $this->get_or_create_term( $location['continent'], 0, $taxonomy );
		}
		
		if ( ! empty( $location['country'] ) && $continent_term_id ) {
			$country_term_id = $this->get_or_create_term( $location['country'], $continent_term_id, $taxonomy );
		}
		
		if ( ! empty( $location['state'] ) && $country_term_id ) {
			$state_term_id = $this->get_or_create_term( $location['state'], $country_term_id, $taxonomy );
		}
		
		if ( ! empty( $location['city'] ) && $state_term_id ) {
			$city_term_id = $this->get_or_create_term( $location['city'], $state_term_id, $taxonomy );
		}
		
		$term_ids = array_filter( array( $continent_term_id, $country_term_id, $state_term_id, $city_term_id ) );
		
		if ( ! empty( $term_ids ) ) {
			wp_set_object_terms( $post_id, $term_ids, $taxonomy, false );
		}
	}
	
	/**
	 * Get or create term.
	 *
	 * Retrieves an existing term by name or creates it if it doesn't exist.
	 * Updates parent relationship if the term exists but has wrong parent.
	 *
	 * @since 0.1.0
	 * @param string $name      Term name.
	 * @param int    $parent_id Parent term ID (0 for top-level).
	 * @param string $taxonomy  Taxonomy name.
	 * @return int Term ID, or 0 on failure.
	 */
	private function get_or_create_term( string $name, int $parent_id, string $taxonomy ): int {
		$name = sanitize_text_field( $name );
		
		$existing_term = get_term_by( 'name', $name, $taxonomy );
		
		if ( $existing_term instanceof \WP_Term ) {
			if ( $existing_term->parent !== $parent_id ) {
				wp_update_term(
					$existing_term->term_id,
					$taxonomy,
					array( 'parent' => $parent_id )
				);
			}
			return $existing_term->term_id;
		}
		
		$term = wp_insert_term(
			$name,
			$taxonomy,
			array( 'parent' => $parent_id )
		);
		
		if ( is_wp_error( $term ) ) {
			error_log( 'GatherPress Venue Hierarchy: Failed to create term - ' . $term->get_error_message() );
			return 0;
		}
		
		if ( ! is_array( $term ) || ! isset( $term['term_id'] ) ) {
			return 0;
		}
		
		return $term['term_id'];
	}
}

if ( ! function_exists( 'gatherpress_venue_hierarchy_init' ) ) {
	/**
	 * Initialize the plugin.
	 *
	 * Bootstrap function that initializes the main plugin class.
	 * Hooked to 'plugins_loaded' to ensure WordPress core is fully loaded.
	 *
	 * @since 0.1.0
	 * @return void
	 */
	function gatherpress_venue_hierarchy_init(): void {
		GatherPress_Venue_Hierarchy::get_instance();
	}
	add_action( 'plugins_loaded', 'gatherpress_venue_hierarchy_init' );
}]]></content>
  </file>
  <file path="src/block.json">
    <description>This file contains metadata about the block including its name, title, category, icon, and other properties. The icon is a WordPress Dashicon name (e.g., "admin-post", "format-aside", "admin-page"). Do not use any icon that's not in the list under any circustamce. These are the only slugs available:
	
	menu menu-alt menu-alt2 menu-alt3 admin-site admin-site-alt admin-site-alt2 admin-site-alt3 dashboard admin-post admin-media admin-links admin-page admin-comments admin-appearance admin-plugins plugins-checked admin-users admin-tools admin-settings admin-network admin-home admin-generic admin-collapse filter admin-customizer admin-multisite welcome-write-blog welcome-add-page welcome-view-site welcome-widgets-menus welcome-comments welcome-learn-more format-aside format-image format-gallery format-video format-status format-quote format-chat format-audio camera camera-alt images-alt images-alt2 video-alt video-alt2 video-alt3 media-archive media-audio media-code media-default media-document media-interactive media-spreadsheet media-text media-video playlist-audio playlist-video controls-play controls-pause controls-forward controls-skipforward controls-back controls-skipback controls-repeat controls-volumeon controls-volumeoff image-crop image-rotate image-rotate-left image-rotate-right image-flip-vertical image-flip-horizontal image-filter undo redo database-add database database-export database-import database-remove database-view align-full-width align-pull-left align-pull-right align-wide block-default button cloud-saved cloud-upload columns cover-image ellipsis embed-audio embed-generic embed-photo embed-post embed-video exit heading html info-outline insert insert-after insert-before remove saved shortcode table-col-after table-col-before table-col-delete table-row-after table-row-before table-row-delete editor-bold editor-italic editor-ul editor-ol editor-ol-rtl editor-quote editor-alignleft editor-aligncenter editor-alignright editor-insertmore editor-spellcheck editor-expand editor-contract editor-kitchensink editor-underline editor-justify editor-textcolor editor-paste-word editor-paste-text editor-removeformatting editor-video editor-customchar editor-outdent editor-indent editor-help editor-strikethrough editor-unlink editor-rtl editor-ltr editor-break editor-code editor-paragraph editor-table align-left align-right align-center align-none lock unlock calendar calendar-alt visibility hidden post-status edit trash sticky external arrow-up arrow-down arrow-right arrow-left arrow-up-alt arrow-down-alt arrow-right-alt arrow-left-alt arrow-up-alt2 arrow-down-alt2 arrow-right-alt2 arrow-left-alt2 sort leftright randomize list-view excerpt-view grid-view move share share-alt share-alt2 rss email email-alt email-alt2 networking amazon facebook facebook-alt google instagram linkedin pinterest podio reddit spotify twitch twitter twitter-alt whatsapp xing youtube hammer art migrate performance universal-access universal-access-alt tickets nametag clipboard heart megaphone schedule tide rest-api code-standards buddicons-activity buddicons-bbpress-logo buddicons-buddypress-logo buddicons-community buddicons-forums buddicons-friends buddicons-groups buddicons-pm buddicons-replies buddicons-topics buddicons-tracking wordpress wordpress-alt pressthis update update-alt screenoptions info cart feedback cloud translation tag category archive tagcloud text bell yes yes-alt no no-alt plus plus-alt plus-alt2 minus dismiss marker star-filled star-half star-empty flag warning location location-alt vault shield shield-alt sos search slides text-page analytics chart-pie chart-bar chart-line chart-area groups businessman businesswoman businessperson id id-alt products awards forms testimonial portfolio book book-alt download upload backup clock lightbulb microphone desktop laptop tablet smartphone phone index-card carrot building store album palmtree tickets-alt money money-alt smiley thumbs-up thumbs-down layout paperclip color-picker edit-large edit-page airplane bank beer calculator car coffee drumstick food fullscreen-alt fullscreen-exit-alt games hourglass open-folder pdf pets printer privacy superhero superhero-alt</description>
    <content><![CDATA[{
	"$schema": "https://schemas.wp.org/trunk/block.json",
	"apiVersion": 3,
	"name": "telex/block-gatherpress-venue-hierarchy",
	"version": "0.1.0",
	"title": "Location Hierarchy Display",
	"category": "widgets",
	"icon": "location",
	"description": "Displays the complete location hierarchy as inline text",
	"example": {},
	"attributes": {
		"startLevel": {
			"type": "number",
			"default": 1
		},
		"endLevel": {
			"type": "number",
			"default": 999
		},
		"enableLinks": {
			"type": "boolean",
			"default": false
		},
		"linkColor": {
			"type": "string",
			"default": ""
		},
		"showVenue": {
			"type": "boolean",
			"default": false
		}
	},
	"usesContext": ["postId", "postType"],
	"supports": {
		"html": false,
		"align": true,
		"color": {
			"link": true,
			"text": true,
			"background": true
		}
	},
	"textdomain": "gatherpress-venue-hierarchy",
	"editorScript": "file:./index.js",
	"editorStyle": "file:./index.css",
	"style": "file:./style-index.css",
	"render": "file:./render.php"
}]]></content>
  </file>
  <file path="src/index.js">
    <description>This file registers the block, specifies the edit and save functions, and loads the block's metadata</description>
    <content><![CDATA[
  /**
 * Registers a new block provided a unique name and an object defining its behavior.
 *
 * @see https://developer.wordpress.org/block-editor/reference-guides/block-api/block-registration/
 */
import { registerBlockType } from '@wordpress/blocks';

/**
 * Lets webpack process CSS, SASS or SCSS files referenced in JavaScript files.
 * All files containing `style` keyword are bundled together. The code used
 * gets applied both to the front of your site and to the editor.
 *
 * @see https://www.npmjs.com/package/@wordpress/scripts#using-css
 */
import './style.scss';

/**
 * Internal dependencies
 */
import Edit from './edit';
import metadata from './block.json';

/**
 * Every block starts by registering a new block type definition.
 *
 * @see https://developer.wordpress.org/block-editor/reference-guides/block-api/block-registration/
 */
registerBlockType( metadata.name, {
	/**
	 * @see ./edit.js
	 */
	edit: Edit,
} );
	]]></content>
  </file>
  <file path="src/edit.js">
    <description>This file contains the edit function for the block which is responsible for rendering the block in the editor.</description>
    <content><![CDATA[/**
 * Retrieves the translation of text.
 *
 * @see https://developer.wordpress.org/block-editor/reference-guides/packages/packages-i18n/
 */
import { __ } from '@wordpress/i18n';

/**
 * React hook that is used to mark the block wrapper element.
 * It provides all the necessary props like the class name.
 *
 * @see https://developer.wordpress.org/block-editor/reference-guides/packages/packages-block-editor/#useblockprops
 */
import { useBlockProps, InspectorControls } from '@wordpress/block-editor';
import { PanelBody, ToggleControl, Spinner } from '@wordpress/components';
import { useState, useEffect } from '@wordpress/element';
import { useSelect } from '@wordpress/data';
import apiFetch from '@wordpress/api-fetch';

/**
 * Lets webpack process CSS, SASS or SCSS files referenced in JavaScript files.
 * Those files can contain any CSS code that gets applied to the editor.
 *
 * @see https://www.npmjs.com/package/@wordpress/scripts#using-css
 */
import './editor.scss';

/**
 * Custom Dual Range Control Component
 *
 * A range slider with two handles for selecting start and end levels.
 */
function DualRangeControl( { startLevel, endLevel, maxLevel, onChange } ) {
	const [ isDragging, setIsDragging ] = useState( null );
	const [ trackRef, setTrackRef ] = useState( null );
	
	const levelLabels = [
		__( 'Continent', 'gatherpress-venue-hierarchy' ),
		__( 'Country', 'gatherpress-venue-hierarchy' ),
		__( 'State', 'gatherpress-venue-hierarchy' ),
		__( 'City', 'gatherpress-venue-hierarchy' ),
		__( 'Street', 'gatherpress-venue-hierarchy' ),
	];
	
	const getPositionFromLevel = ( level ) => {
		return ( ( level - 1 ) / ( maxLevel - 1 ) ) * 100;
	};
	
	const getLevelFromPosition = ( clientX ) => {
		if ( ! trackRef ) return 1;
		
		const rect = trackRef.getBoundingClientRect();
		const position = ( clientX - rect.left ) / rect.width;
		const level = Math.round( position * ( maxLevel - 1 ) ) + 1;
		
		return Math.max( 1, Math.min( maxLevel, level ) );
	};
	
	const handleMouseDown = ( handle ) => ( e ) => {
		e.preventDefault();
		setIsDragging( handle );
	};
	
	const handleMouseMove = ( e ) => {
		if ( ! isDragging ) return;
		
		const newLevel = getLevelFromPosition( e.clientX );
		
		if ( isDragging === 'start' ) {
			if ( newLevel <= endLevel ) {
				onChange( { startLevel: newLevel, endLevel } );
			}
		} else if ( isDragging === 'end' ) {
			if ( newLevel >= startLevel ) {
				onChange( { startLevel, endLevel: newLevel } );
			}
		}
	};
	
	const handleMouseUp = () => {
		setIsDragging( null );
	};
	
	useEffect( () => {
		if ( isDragging ) {
			document.addEventListener( 'mousemove', handleMouseMove );
			document.addEventListener( 'mouseup', handleMouseUp );
			
			return () => {
				document.removeEventListener( 'mousemove', handleMouseMove );
				document.removeEventListener( 'mouseup', handleMouseUp );
			};
		}
	}, [ isDragging, startLevel, endLevel ] );
	
	const startPos = getPositionFromLevel( startLevel );
	const endPos = getPositionFromLevel( endLevel );
	
	return (
		<div className="dual-range-control">
			<div className="dual-range-control__labels">
				{ levelLabels.slice( 0, maxLevel ).map( ( label, index ) => (
					<span key={ index } className="dual-range-control__label">
						{ label }
					</span>
				) ) }
			</div>
			
			<div className="dual-range-control__track-container">
				<div 
					ref={ setTrackRef }
					className="dual-range-control__track"
				>
					<div 
						className="dual-range-control__range"
						style={ {
							left: `${ startPos }%`,
							width: `${ endPos - startPos }%`,
						} }
					/>
					
					<button
						type="button"
						className={ `dual-range-control__handle dual-range-control__handle--start ${ isDragging === 'start' ? 'is-dragging' : '' }` }
						style={ { left: `${ startPos }%` } }
						onMouseDown={ handleMouseDown( 'start' ) }
						aria-label={ __( 'Start level', 'gatherpress-venue-hierarchy' ) }
					/>
					
					<button
						type="button"
						className={ `dual-range-control__handle dual-range-control__handle--end ${ isDragging === 'end' ? 'is-dragging' : '' }` }
						style={ { left: `${ endPos }%` } }
						onMouseDown={ handleMouseDown( 'end' ) }
						aria-label={ __( 'End level', 'gatherpress-venue-hierarchy' ) }
					/>
				</div>
			</div>
			
			<div className="dual-range-control__output">
				<span className="dual-range-control__output-label">
					{ __( 'Showing:', 'gatherpress-venue-hierarchy' ) }
				</span>
				<strong>
					{ levelLabels[ startLevel - 1 ] || '' }
					{ startLevel !== endLevel && (
						<>
							{ ' ' + __( 'to', 'gatherpress-venue-hierarchy' ) + ' ' }
							{ levelLabels[ endLevel - 1 ] || '' }
						</>
					) }
				</strong>
			</div>
		</div>
	);
}

/**
 * The edit function describes the structure of your block in the context of the
 * editor. This represents what the editor will render when the block is used.
 *
 * @see https://developer.wordpress.org/block-editor/reference-guides/block-api/block-edit-save/#edit
 *
 * @return {Element} Element to render.
 */
export default function Edit( { attributes, setAttributes, context } ) {
	const { startLevel, endLevel, enableLinks, showVenue } = attributes;
	const [ locationHierarchy, setLocationHierarchy ] = useState( '' );
	const [ venueName, setVenueName ] = useState( '' );
	const [ maxDepth, setMaxDepth ] = useState( 5 );
	const [ isLoading, setIsLoading ] = useState( true );
	const [ error, setError ] = useState( null );
	
	// Get the current post ID from the editor store
	const currentPostId = useSelect( ( select ) => {
		return select( 'core/editor' ).getCurrentPostId();
	}, [] );
	
	// Get the current post type from the editor store
	const currentPostType = useSelect( ( select ) => {
		return select( 'core/editor' ).getCurrentPostType();
	}, [] );
	
	// Use context values as fallback, but prefer the editor store values
	const postId = currentPostId || context.postId;
	const postType = currentPostType || context.postType;
	
	// Check if we're in a GatherPress event context
	if ( postType && postType !== 'gatherpress_event' ) {
		return (
			<p { ...useBlockProps() }>
				{ __( 'This block must be used within a GatherPress event', 'gatherpress-venue-hierarchy' ) }
			</p>
		);
	}
	
	useEffect( () => {
		if ( ! postId ) {
			setLocationHierarchy( __( 'No post ID available', 'gatherpress-venue-hierarchy' ) );
			setIsLoading( false );
			return;
		}
		
		const fetchLocationData = async () => {
			try {
				setIsLoading( true );
				setError( null );
				
				// Fetch terms directly via REST API
				const terms = await apiFetch( {
					path: `/wp/v2/gatherpress-location?post=${ postId }&per_page=100`,
				} );
				
				// Fetch event data to get venue information
				let eventVenueName = '';
				try {
					const event = await apiFetch( {
						path: `/wp/v2/gatherpress_event/${ postId }`,
					} );
					
					if ( event && event.venue ) {
						eventVenueName = event.venue.name || '';
					}
				} catch ( venueError ) {
					console.log( 'Could not fetch venue information:', venueError );
				}
				
				setVenueName( eventVenueName );
				
				if ( ! terms || terms.length === 0 ) {
					if ( showVenue && eventVenueName ) {
						setLocationHierarchy( eventVenueName );
					} else {
						setLocationHierarchy( __( 'No location hierarchy available for this event', 'gatherpress-venue-hierarchy' ) );
					}
					setIsLoading( false );
					return;
				}
				
				const buildTermPath = ( term, allTerms ) => {
					const path = [];
					let currentTerm = term;
					
					while ( currentTerm ) {
						path.unshift( currentTerm.name );
						
						if ( currentTerm.parent && currentTerm.parent !== 0 ) {
							currentTerm = allTerms.find( t => t.id === currentTerm.parent );
						} else {
							break;
						}
					}
					
					return path;
				};
				
				// Find leaf terms (deepest terms in each hierarchy)
				const termIds = terms.map( t => t.id );
				const parentIds = terms.map( t => t.parent );
				const leafTerms = terms.filter( term => ! parentIds.includes( term.id ) );
				
				const hierarchyPaths = leafTerms.map( term => buildTermPath( term, terms ) );
				
				// Calculate the maximum depth
				const calculatedMaxDepth = Math.max( ...hierarchyPaths.map( path => path.length ) );
				setMaxDepth( Math.min( calculatedMaxDepth, 5 ) ); // Cap at 5 levels
				
				// Filter paths based on start and end levels
				const filteredPaths = hierarchyPaths.map( path => {
					const actualStartLevel = Math.max( 1, startLevel );
					const actualEndLevel = Math.min( endLevel, path.length );
					
					if ( actualStartLevel > path.length ) {
						return '';
					}
					
					return path.slice( actualStartLevel - 1, actualEndLevel ).join( ' > ' );
				} ).filter( path => path !== '' );
				
				if ( filteredPaths.length > 0 ) {
					let hierarchyText = filteredPaths.join( ', ' );
					
					// Add venue name if requested and available
					if ( showVenue && eventVenueName ) {
						hierarchyText += ' > ' + eventVenueName;
					}
					
					setLocationHierarchy( hierarchyText );
				} else {
					// If no filtered paths but venue is requested, show just venue
					if ( showVenue && eventVenueName ) {
						setLocationHierarchy( eventVenueName );
					} else {
						setLocationHierarchy( __( 'No location hierarchy available at selected levels', 'gatherpress-venue-hierarchy' ) );
					}
				}
				setIsLoading( false );
			} catch ( err ) {
				console.error( 'Error fetching location data:', err );
				setError( err.message || 'Unknown error' );
				
				// Even on error, try to show venue if requested
				if ( showVenue && venueName ) {
					setLocationHierarchy( venueName );
				} else {
					setLocationHierarchy( __( 'Error loading location hierarchy', 'gatherpress-venue-hierarchy' ) );
				}
				setIsLoading( false );
			}
		};
		
		fetchLocationData();
	}, [ postId, startLevel, endLevel, showVenue ] );
	
	if ( error ) {
		return (
			<p { ...useBlockProps() }>
				{ __( 'Error: ', 'gatherpress-venue-hierarchy' ) } { error }
			</p>
		);
	}
	
	return (
		<>
			<InspectorControls>
				<PanelBody
					title={ __( 'Hierarchy Levels', 'gatherpress-venue-hierarchy' ) }
					initialOpen={ true }
				>
					<DualRangeControl
						startLevel={ startLevel }
						endLevel={ Math.min( endLevel, maxDepth ) }
						maxLevel={ maxDepth }
						onChange={ ( { startLevel: newStart, endLevel: newEnd } ) => {
							setAttributes( {
								startLevel: newStart,
								endLevel: newEnd,
							} );
						} }
					/>
				</PanelBody>
				<PanelBody
					title={ __( 'Display Options', 'gatherpress-venue-hierarchy' ) }
					initialOpen={ true }
				>
					<ToggleControl
						label={ __( 'Show venue', 'gatherpress-venue-hierarchy' ) }
						help={ __( 'Display the venue name at the end of the location hierarchy', 'gatherpress-venue-hierarchy' ) }
						checked={ showVenue }
						onChange={ ( value ) => setAttributes( { showVenue: value } ) }
					/>
					<ToggleControl
						label={ __( 'Enable term links', 'gatherpress-venue-hierarchy' ) }
						help={ __( 'Link each location term to its archive page', 'gatherpress-venue-hierarchy' ) }
						checked={ enableLinks }
						onChange={ ( value ) => setAttributes( { enableLinks: value } ) }
					/>
				</PanelBody>
			</InspectorControls>
			<p { ...useBlockProps() }>
				{ isLoading ? <Spinner /> : locationHierarchy }
			</p>
		</>
	);
}]]></content>
  </file>
  <file path="src/save.js">
    <description>This file contains the save function for the block which is responsible for creating the static result of rendering the block on the client to display the saved result on the front end.</description>
    <content><![CDATA[
	]]></content>
  </file>
  <file path="src/style.scss">
    <description>This file contains styles for the block in the front end.</description>
    <content><![CDATA[/**
 * The following styles get applied both on the front of your site
 * and in the editor.
 *
 * Replace them with your own styles or remove the file completely.
 */

.wp-block-telex-block-gatherpress-venue-hierarchy {
	padding: 1em;
	background-color: #f7f7f7;
	border-left: 4px solid #0073aa;
	margin: 1em 0;
	
	&.alignleft {
		margin-right: 1em;
		max-width: 50%;
	}
	
	&.alignright {
		margin-left: 1em;
		max-width: 50%;
	}
	
	&.aligncenter {
		margin-left: auto;
		margin-right: auto;
		text-align: center;
	}
	
	&.alignfull {
		margin-left: 0;
		margin-right: 0;
	}
	
	// Link styles
	.gatherpress-location-link {
		color: inherit;
		text-decoration: none;
		transition: opacity 0.2s ease;
		
		&:hover {
			opacity: 0.7;
			text-decoration: underline;
		}
		
		&:focus {
			outline: 2px solid currentColor;
			outline-offset: 2px;
		}
	}
	
	// Venue link with slightly different styling
	.gatherpress-venue-link {
		font-weight: 500;
	}
}]]></content>
  </file>
  <file path="src/editor.scss">
    <description>This file contains styles for the block in the editor.</description>
    <content><![CDATA[/**
 * The following styles get applied inside the editor only.
 *
 * Replace them with your own styles or remove the file completely.
 */

.wp-block-telex-block-gatherpress-venue-hierarchy {
	// Remove extra styling - let it match frontend
}

/* Dual Range Control Styles */
.dual-range-control {
	padding: 16px 0;
	
	&__labels {
		display: flex;
		justify-content: space-between;
		margin-bottom: 12px;
		padding: 0 8px;
	}
	
	&__label {
		font-size: 11px;
		color: #757575;
		font-weight: 500;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}
	
	&__track-container {
		padding: 0 8px;
		margin-bottom: 16px;
	}
	
	&__track {
		position: relative;
		height: 4px;
		background-color: #ddd;
		border-radius: 2px;
		cursor: pointer;
	}
	
	&__range {
		position: absolute;
		top: 0;
		height: 100%;
		background-color: #0073aa;
		border-radius: 2px;
		pointer-events: none;
	}
	
	&__handle {
		position: absolute;
		top: 50%;
		width: 20px;
		height: 20px;
		margin-left: -10px;
		margin-top: -10px;
		background-color: #fff;
		border: 2px solid #0073aa;
		border-radius: 50%;
		cursor: grab;
		box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
		transition: transform 0.1s ease, box-shadow 0.1s ease;
		z-index: 2;
		
		&:hover {
			transform: scale(1.15);
			box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
		}
		
		&:focus {
			outline: 2px solid #0073aa;
			outline-offset: 2px;
		}
		
		&.is-dragging {
			cursor: grabbing;
			transform: scale(1.25);
			box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
			z-index: 3;
		}
		
		&--start {
			background-color: #fff;
		}
		
		&--end {
			background-color: #fff;
		}
	}
	
	&__output {
		text-align: center;
		padding: 8px 12px;
		background-color: #f7f7f7;
		border-radius: 4px;
		font-size: 13px;
		
		&-label {
			color: #757575;
			margin-right: 6px;
		}
		
		strong {
			color: #0073aa;
			font-weight: 600;
		}
	}
}]]></content>
  </file>
  <file path="src/view.js">
    <description>This file contains the view function for the block which is responsible for rendering interactive behaviors of the block on the front end. Ideally using the WordPress interactivity API.</description>
    <content><![CDATA[
  /**
 * Use this file for JavaScript code that you want to run in the front-end
 * on posts/pages that contain this block.
 */
	]]></content>
  </file>
  <file path="src/render.php">
    <content><![CDATA[<?php
/**
 * Block renderer for the location hierarchy display block.
 *
 * This file contains the singleton renderer class and serves as the
 * render callback for the block. It retrieves event venue information
 * and builds the complete hierarchical location path for display.
 *
 * @package GatherPressVenueHierarchy
 * @since 0.1.0
 */

if ( ! defined( 'ABSPATH' ) ) {
	exit;
}
if( ! class_exists('GatherPress_Venue_Hierarchy_Block_Renderer')) {

	/**
	 * Block renderer class using Singleton pattern.
	 *
	 * Handles rendering of the location hierarchy display block,
	 * retrieving event venue information and building the complete
	 * hierarchical location path for display.
	 *
	 * @since 0.1.0
	 */
	class GatherPress_Venue_Hierarchy_Block_Renderer {
		
		/**
		 * Single instance.
		 *
		 * @since 0.1.0
		 * @var GatherPress_Venue_Hierarchy_Block_Renderer|null
		 */
		private static $instance = null;
		
		/**
		 * Get singleton instance.
		 *
		 * @since 0.1.0
		 * @return GatherPress_Venue_Hierarchy_Block_Renderer The singleton instance.
		 */
		public static function get_instance(): GatherPress_Venue_Hierarchy_Block_Renderer {
			if ( null === self::$instance ) {
				self::$instance = new self();
			}
			return self::$instance;
		}
		
		/**
		 * Constructor.
		 *
		 * Private constructor to enforce singleton pattern.
		 *
		 * @since 0.1.0
		 */
		private function __construct() {}
		
		/**
		 * Render block content.
		 *
		 * Retrieves the event's venue location hierarchy and renders
		 * it as an inline text display with proper formatting.
		 *
		 * @since 0.1.0
		 * @param array<string, mixed> $attributes Block attributes.
		 * @param string              $content    Block content.
		 * @param \WP_Block            $block      Block instance.
		 * @return string Rendered block HTML.
		 */
		public function render( array $attributes, string $content, \WP_Block $block ): string {
			// Get post ID from context
			$post_id = $block->context['postId'] ?? 0;
			
			if ( ! $post_id ) {
				return '';
			}
			
			$post_id = absint( $post_id );
			$post = get_post( $post_id );
			
			if ( ! $post ) {
				return '';
			}
			
			// Verify this is a GatherPress event
			if ( 'gatherpress_event' !== $post->post_type ) {
				return '';
			}
			
			// Get hierarchy level attributes
			$start_level = isset( $attributes['startLevel'] ) ? absint( $attributes['startLevel'] ) : 1;
			$end_level = isset( $attributes['endLevel'] ) ? absint( $attributes['endLevel'] ) : 999;
			$enable_links = isset( $attributes['enableLinks'] ) ? (bool) $attributes['enableLinks'] : false;
			$show_venue = isset( $attributes['showVenue'] ) ? (bool) $attributes['showVenue'] : false;
			
			// Ensure start level is at least 1
			$start_level = max( 1, $start_level );
			
			// Ensure end level is at least equal to start level
			$end_level = max( $start_level, $end_level );
			
			// Get venue information if requested
			$venue_name = '';
			$venue_link = '';
			
			if ( $show_venue && class_exists( 'GatherPress\Core\Event' ) ) {
				$event = new \GatherPress\Core\Event( $post_id );
				$venue_info = $event->get_venue_information();
				
				if ( is_array( $venue_info ) ) {
					$venue_name = $venue_info['name'] ?? '';
					$venue_link = $venue_info['permalink'] ?? '';
				}
			}
			
			// Get location terms for this event
			$location_terms = wp_get_object_terms(
				$post_id,
				'gatherpress-location',
				array(
					'orderby' => 'parent',
					'order' => 'ASC',
				)
			);
			
			if ( is_wp_error( $location_terms ) ) {
				error_log( 'GatherPress Venue Hierarchy Block: Error getting terms - ' . $location_terms->get_error_message() );
				
				// If showing venue and we have venue info, show just the venue
				if ( $show_venue && $venue_name ) {
					return $this->render_output( $venue_name, $venue_link, $enable_links );
				}
				
				return '';
			}
			
			if ( empty( $location_terms ) ) {
				// If showing venue and we have venue info, show just the venue
				if ( $show_venue && $venue_name ) {
					return $this->render_output( $venue_name, $venue_link, $enable_links );
				}
				
				return '';
			}
			
			// Build hierarchy paths
			$hierarchy_paths = $this->build_hierarchy_paths( $location_terms, $start_level, $end_level, $enable_links );
			
			if ( empty( $hierarchy_paths ) ) {
				// If showing venue and we have venue info, show just the venue
				if ( $show_venue && $venue_name ) {
					return $this->render_output( $venue_name, $venue_link, $enable_links );
				}
				
				return '';
			}
			
			// Join all paths and add venue if requested
			$hierarchy_text = implode( ', ', $hierarchy_paths );
			
			if ( $show_venue && $venue_name ) {
				// Format venue name with optional link
				if ( $enable_links && $venue_link ) {
					$venue_text = sprintf(
						'<a href="%s" class="gatherpress-location-link gatherpress-venue-link">%s</a>',
						esc_url( $venue_link ),
						esc_html( $venue_name )
					);
				} else {
					$venue_text = esc_html( $venue_name );
				}
				
				$hierarchy_text .= ' > ' . $venue_text;
			}
			
			// Get block wrapper attributes
			$wrapper_attributes = get_block_wrapper_attributes();
			
			// Return formatted output
			return sprintf(
				'<p %s>%s</p>',
				$wrapper_attributes,
				$hierarchy_text
			);
		}
		
		/**
		 * Render output for venue-only display.
		 *
		 * Helper method to render just the venue when no location terms exist.
		 *
		 * @since 0.1.0
		 * @param string $venue_name  Venue name to display.
		 * @param string $venue_link  Venue permalink (optional).
		 * @param bool   $enable_links Whether to link the venue.
		 * @return string Rendered block HTML.
		 */
		private function render_output( string $venue_name, string $venue_link, bool $enable_links ): string {
			$wrapper_attributes = get_block_wrapper_attributes();
			
			if ( $enable_links && $venue_link ) {
				$venue_text = sprintf(
					'<a href="%s" class="gatherpress-location-link gatherpress-venue-link">%s</a>',
					esc_url( $venue_link ),
					esc_html( $venue_name )
				);
			} else {
				$venue_text = esc_html( $venue_name );
			}
			
			return sprintf(
				'<p %s>%s</p>',
				$wrapper_attributes,
				$venue_text
			);
		}
		
		/**
		 * Build hierarchy paths from terms.
		 *
		 * Constructs complete hierarchical paths for each location term,
		 * traversing parent relationships to build full location strings.
		 * Only includes the deepest (most specific) term in each hierarchy branch.
		 * Filters paths based on start and end level settings.
		 * Optionally wraps each term in a link to its archive page.
		 *
		 * @since 0.1.0
		 * @param array<\WP_Term> $terms        Array of term objects.
		 * @param int            $start_level  Starting hierarchy level (1-based).
		 * @param int            $end_level    Ending hierarchy level (1-based).
		 * @param bool           $enable_links Whether to link terms to their archives.
		 * @return array<string> Array of formatted hierarchy paths.
		 */
		private function build_hierarchy_paths( array $terms, int $start_level, int $end_level, bool $enable_links ): array {
			if ( empty( $terms ) ) {
				return array();
			}
			
			// Find the deepest (leaf) terms - those that are not parents of other terms
			$term_ids = wp_list_pluck( $terms, 'term_id' );
			$parent_ids = wp_list_pluck( $terms, 'parent' );
			
			$leaf_terms = array();
			foreach ( $terms as $term ) {
				if ( ! $term instanceof \WP_Term ) {
					continue;
				}
				
				// A term is a leaf if its ID is not in the parent_ids array
				if ( ! in_array( $term->term_id, $parent_ids, true ) ) {
					$leaf_terms[] = $term;
				}
			}
			
			// If no leaf terms found, use all terms
			if ( empty( $leaf_terms ) ) {
				$leaf_terms = $terms;
			}
			
			// Build paths for each leaf term
			$hierarchy_paths = array();
			foreach ( $leaf_terms as $term ) {
				$full_path = $this->build_term_path( $term, $enable_links );
				
				if ( empty( $full_path ) ) {
					continue;
				}
				
				// Filter the path based on start and end levels
				$path_length = count( $full_path );
				
				// Adjust levels to array indices (0-based)
				$start_index = $start_level - 1;
				$end_index = min( $end_level, $path_length );
				
				// Skip if start level is beyond the path length
				if ( $start_index >= $path_length ) {
					continue;
				}
				
				// Extract the relevant slice of the path
				$filtered_path = array_slice( $full_path, $start_index, $end_index - $start_index );
				
				if ( ! empty( $filtered_path ) ) {
					$hierarchy_paths[] = implode( ' > ', $filtered_path );
				}
			}
			
			return $hierarchy_paths;
		}
		
		/**
		 * Build term path.
		 *
		 * Recursively builds the complete hierarchical path for a term
		 * by traversing parent relationships from child to root.
		 * Optionally wraps each term in a link to its archive page.
		 *
		 * @since 0.1.0
		 * @param \WP_Term $term         Term object.
		 * @param bool    $enable_links Whether to link terms to their archives.
		 * @return array<string> Array of term names/links from root to leaf.
		 */
		private function build_term_path( \WP_Term $term, bool $enable_links ): array {
			$path = array();
			$current_term = $term;
			$visited = array();
			
			// Prevent infinite loops
			$max_depth = 10;
			$depth = 0;
			
			while ( $current_term && $depth < $max_depth ) {
				// Check if we've visited this term (prevent infinite loops)
				if ( in_array( $current_term->term_id, $visited, true ) ) {
					break;
				}
				
				$visited[] = $current_term->term_id;
				
				// Format term name with optional link
				if ( $enable_links ) {
					$term_link = get_term_link( $current_term );
					if ( ! is_wp_error( $term_link ) ) {
						$term_text = sprintf(
							'<a href="%s" class="gatherpress-location-link">%s</a>',
							esc_url( $term_link ),
							esc_html( $current_term->name )
						);
					} else {
						$term_text = esc_html( $current_term->name );
					}
				} else {
					$term_text = esc_html( $current_term->name );
				}
				
				array_unshift( $path, $term_text );
				
				if ( $current_term->parent ) {
					$parent_term = get_term( $current_term->parent, 'gatherpress-location' );
					
					if ( is_wp_error( $parent_term ) || ! $parent_term ) {
						break;
					}
					
					$current_term = $parent_term;
				} else {
					break;
				}
				
				$depth++;
			}
			
			return $path;
		}
	}

}
$renderer = GatherPress_Venue_Hierarchy_Block_Renderer::get_instance();
echo $renderer->render( $attributes, $content, $block );]]></content>
  </file>
</artefact>